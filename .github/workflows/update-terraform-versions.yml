name: Update Terraform Versions

on:
  pull_request: # TODO: TEMPORARY - remove after testing
  schedule:
    - cron: '0 7 * * *'  # Daily at 7:00 AM UTC
  workflow_dispatch:
    inputs:
      min_version:
        description: 'Minimum Terraform version'
        required: false

env:
  MIN_VERSION: ${{ inputs.min_version || '1.9' }}

jobs:
  update-terraform-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Fetch and filter Terraform versions
        id: versions
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          versions=$(gh api repos/hashicorp/terraform/releases --paginate | jq --arg min "$MIN_VERSION" '
            [.[].tag_name
             | select(test("^v[0-9]+\\.[0-9]+\\.0$"))
             | ltrimstr("v")
             | rtrimstr(".0")]
            | ($min | split(".") | map(tonumber)) as $minv
            | map(select(
                (split(".") | map(tonumber)) as $v |
                $v[0] > $minv[0] or ($v[0] == $minv[0] and $v[1] >= $minv[1])
              ))
            | sort_by(split(".") | map(tonumber))
            | unique')
          echo "versions=$versions" >> "$GITHUB_OUTPUT"

      - name: Update .terraform-versions.yaml
        run: |
          cat > .terraform-versions.yaml << 'EOF'
          # Terraform CLI versions for compatibility testing
          # Must be subset of provider compatibility matrix (>= 1.9 for cross-variable validation)
          # See: https://registry.terraform.io/providers/mongodb/mongodbatlas-modules/latest/docs#hashicorp-terraform-version-compatibility-matrix
          versions:
          EOF

          echo '${{ steps.versions.outputs.versions }}' | jq -r '.[] | "  - \"" + . + "\""' >> .terraform-versions.yaml

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0
        with:
          token: ${{ secrets.APIX_BOT_PAT }}
          title: 'chore: Update Terraform versions'
          commit-message: 'chore: Update Terraform versions'
          branch: terraform-versions-update
          delete-branch: true
          body: |
            Automated update of `.terraform-versions.yaml` with latest supported Terraform versions.
