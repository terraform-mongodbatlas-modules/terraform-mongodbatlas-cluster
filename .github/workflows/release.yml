name: Release
run-name: >-
  Release ${{ inputs.version }}
  ${{ inputs.skip-pre-release-checks && '(skip-checks)' || '' }}
  ${{ inputs.skip-release-tag && '(skip-tag)' || '' }}
  ${{ inputs.skip-release-github && '(skip-github)' || '' }}
  ${{ inputs.skip-post-release-revert && '(skip-revert)' || '' }}
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      skip-pre-release-checks:
        description: 'Skip pre-release validation'
        required: false
        type: boolean
        default: false
      skip-release-tag:
        description: 'Skip creating release commits and tag'
        required: false
        type: boolean
        default: false
      skip-release-github:
        description: 'Skip creating GitHub release'
        required: false
        type: boolean
        default: false
      skip-post-release-revert:
        description: 'Skip reverting release commit on main'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  # Use APIX_BOT_PAT if available (bypasses branch rulesets), otherwise fall back to GITHUB_TOKEN
  GH_TOKEN: ${{ secrets.APIX_BOT_PAT || github.token }}

jobs:
  pre-release-checks:
    if: ${{ !inputs.skip-pre-release-checks }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          ref: main
      - uses: ./.github/actions/setup
        with:
          just: 'true'
          terraform: 'true'
          docs: 'true'
      - name: Pre-release validation
        run: just check-release-ready ${{ inputs.version }}

  release-tag:
    needs: pre-release-checks
    if: ${{ always() && !inputs.skip-release-tag && (needs.pre-release-checks.result == 'success' || needs.pre-release-checks.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          ref: main
          token: ${{ env.GH_TOKEN }}
      - uses: ./.github/actions/setup
        with:
          just: 'true'
          terraform: 'true'
          docs: 'true'
      - name: Configure Git
        run: |
          if [[ -n "${{ secrets.APIX_BOT_PAT }}" ]]; then
            git config user.name "apix-bot[bot]"
            git config user.email "apix-bot[bot]@users.noreply.github.com"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
          fi
      - name: Create release commits and tag
        run: just release-commit ${{ inputs.version }}
      - name: Push tag
        run: git push origin ${{ inputs.version }}

  release-github:
    needs: release-tag
    if: ${{ always() && !inputs.skip-release-github && (needs.release-tag.result == 'success' || needs.release-tag.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          ref: ${{ inputs.version }}
      - uses: ./.github/actions/setup
        with:
          just: 'true'
      - name: Generate release body
        id: release_body
        run: |
          BODY=$(just generate-release-body ${{ inputs.version }})
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Create GitHub Release
        uses: softprops/action-gh-release@7b4da11513bf3f43f9999e90eabced41ab8bb048
        with:
          tag_name: ${{ inputs.version }}
          name: ${{ inputs.version }}
          body: ${{ steps.release_body.outputs.body }}
          draft: false
          prerelease: false

  post-release-revert:
    needs: release-tag
    if: ${{ always() && !inputs.skip-post-release-revert && (needs.release-tag.result == 'success' || needs.release-tag.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          ref: main
          token: ${{ env.GH_TOKEN }}
      - name: Configure Git
        run: |
          if [[ -n "${{ secrets.APIX_BOT_PAT }}" ]]; then
            git config user.name "apix-bot[bot]"
            git config user.email "apix-bot[bot]@users.noreply.github.com"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
          fi
      - name: Pull latest main with release commits
        run: git pull origin main
      - name: Revert release commit
        run: git revert HEAD --no-edit
      - name: Push main with changelog and revert
        run: git push origin main
