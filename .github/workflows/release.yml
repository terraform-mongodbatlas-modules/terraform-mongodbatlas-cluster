name: Release
run-name: 'Release ${{ inputs.version }}'
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

env:
  # Use APIX_BOT_PAT if available (bypasses branch rulesets), otherwise fall back to GITHUB_TOKEN
  GH_TOKEN: ${{ secrets.APIX_BOT_PAT || github.token }}

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          ref: main
          token: ${{ env.GH_TOKEN }}
      - uses: ./.github/actions/setup
        with:
          just: 'true'
          terraform: 'true'
          docs: 'true'
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Pre-release validation
        run: just check-release-ready ${{ inputs.version }}
      
      - name: Create release commits and tag
        run: just release-commit ${{ inputs.version }}
      
      - name: Push tag
        run: git push origin ${{ inputs.version }}
      
      - name: Revert release commit on main
        run: just release-post-push
      
      - name: Push main with changelog and revert
        run: git push origin main
      
      - name: Generate release body
        id: release_body
        run: |
          BODY=$(just generate-release-body ${{ inputs.version }})
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@7b4da11513bf3f43f9999e90eabced41ab8bb048
        with:
          tag_name: ${{ inputs.version }}
          name: ${{ inputs.version }}
          body: ${{ steps.release_body.outputs.body }}
          draft: false
          prerelease: false
